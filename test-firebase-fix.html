<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Emulator Test</title>
</head>
<body>
    <h1>Testing Firebase Emulator Connection</h1>
    <div id="status">Loading...</div>
    <div id="console-output"></div>

    <script type="module">
        // Override console methods to capture output
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;

        const output = document.getElementById('console-output');

        function addToOutput(level, message) {
            const div = document.createElement('div');
            div.style.color = level === 'error' ? 'red' : level === 'warn' ? 'orange' : 'black';
            div.textContent = `[${level.toUpperCase()}] ${message}`;
            output.appendChild(div);
        }

        console.log = (...args) => {
            originalLog(...args);
            addToOutput('log', args.join(' '));
        };

        console.warn = (...args) => {
            originalWarn(...args);
            addToOutput('warn', args.join(' '));
        };

        console.error = (...args) => {
            originalError(...args);
            addToOutput('error', args.join(' '));
        };

        // Set up environment variables
        window.__vite_env = {
            DEV: true,
            VITE_FIREBASE_USE_EMULATOR: 'true',
            VITE_FIREBASE_API_KEY: 'demo-key',
            VITE_FIREBASE_AUTH_DOMAIN: 'demo-project.firebaseapp.com',
            VITE_FIREBASE_PROJECT_ID: 'demo-project',
            VITE_FIREBASE_STORAGE_BUCKET: 'demo-project.appspot.com',
            VITE_FIREBASE_MESSAGING_SENDER_ID: '123456789',
            VITE_FIREBASE_APP_ID: '1:123456789:web:demo-app-id'
        };

        // Mock import.meta.env
        const originalImportMeta = window.import?.meta?.env;
        Object.defineProperty(window, 'import', {
            value: {
                meta: {
                    env: window.__vite_env
                }
            }
        });

        try {
            console.log('Starting Firebase emulator connection test...');

            // Import Firebase modules
            const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js');
            const { getAuth, connectAuthEmulator } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js');
            const { getFirestore, connectFirestoreEmulator } = await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');

            // Initialize Firebase with demo config
            const app = initializeApp({
                apiKey: 'demo-key',
                authDomain: 'demo-project.firebaseapp.com',
                projectId: 'demo-project',
            });

            const auth = getAuth(app);
            const db = getFirestore(app);

            console.log('Firebase initialized successfully');

            // Test the fixed emulator connection logic
            try {
                console.log('Testing Auth emulator connection...');
                connectAuthEmulator(auth, 'http://localhost:9099', { disableWarnings: true });
                console.log('‚úÖ Auth emulator connection succeeded (or already connected)');
            } catch (authError) {
                if (authError.message?.includes('already')) {
                    console.log('‚úÖ Auth emulator already connected');
                } else {
                    console.warn('‚ö†Ô∏è Auth emulator connection failed:', authError.message);
                }
            }

            try {
                console.log('Testing Firestore emulator connection...');
                connectFirestoreEmulator(db, 'localhost', 8080);
                console.log('‚úÖ Firestore emulator connection succeeded (or already connected)');
            } catch (firestoreError) {
                if (firestoreError.message?.includes('already')) {
                    console.log('‚úÖ Firestore emulator already connected');
                } else {
                    console.warn('‚ö†Ô∏è Firestore emulator connection failed:', firestoreError.message);
                }
            }

            document.getElementById('status').textContent = '‚úÖ Test completed - check console output above';
            console.log('üéâ Firebase emulator test completed successfully without auth.config errors!');

        } catch (error) {
            console.error('‚ùå Test failed:', error);
            document.getElementById('status').textContent = '‚ùå Test failed - check console output';
        }
    </script>
</body>
</html>